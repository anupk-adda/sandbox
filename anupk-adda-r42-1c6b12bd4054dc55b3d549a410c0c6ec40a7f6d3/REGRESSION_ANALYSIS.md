# GRAPH RENDERING REGRESSION ANALYSIS

**Date:** 2026-02-07  
**Analyzed by:** Bob  
**Status:** Investigation Complete - Ready for Fixes

---

## EXECUTIVE SUMMARY

The graph rendering regression has **5 distinct root causes** across frontend and backend components. The primary issue is that the `RunTrendsCompare` widget is being incorrectly used for single-run analysis, causing wrong labels, incorrect range options, and performance issues.

---

## ROOT CAUSE ANALYSIS

### Issue 1: Wrong Labeling ("Run 1, Run 2" instead of dates)

**Location:** `agent-service/src/utils/chart_builder.py`  
**Lines:** 64-67  
**Problem:**  
The `_format_date()` function correctly formats dates as "Jan 15", "Feb 03", but falls back to "Run N" format when date is unavailable or parsing fails. The fallback is being triggered for single-run analysis.

```python
# Line 64-67
label = _format_date(activity_data.get("date"))
if label == "Unknown":
    label = f"Run {idx}"  # ← FALLBACK CAUSING ISSUE
labels.append(label)
```

**Root Cause:**  
When `current_run_analyzer.py` calls `build_run_metric_charts()` with 4 activities (line 98), it's building trend charts for a single-run analysis context. The chart builder is designed for multi-run trends, not single-run detailed analysis.

**Impact:**  
- X-axis shows "Run 1, Run 2, Run 3, Run 4" instead of actual dates
- Confusing for users expecting to see a single run's detailed metrics
- Misrepresents the data as a comparison when it's actually a single run analysis

---

### Issue 2: Range Options (8, 12 instead of 4, 10)

**Location:** `frontend/src/components/RunTrendsCompare.tsx`  
**Lines:** 37, 358  
**Problem:**  
The component hardcodes range options as `[4, 8, 12]` but the requirements specify `[4, 10]` only.

```typescript
// Line 37
const [range, setRange] = useState<RangeOption>(8);  // ← Default is 8

// Line 358
{([4, 8, 12] as RangeOption[]).map((r) => (  // ← Wrong options
```

**Also affects:**  
- `frontend/src/types/chart.types.ts` line 7: `export type RangeOption = 4 | 8 | 12;`

**Root Cause:**  
The type definition and UI implementation don't match the product requirements. The component was built with 8 as default and includes 12 as an option.

**Impact:**  
- Users see incorrect range options
- Default selection (8) is not a valid option per requirements
- Confusion about available data ranges

---

### Issue 3: "Error: Not found" Message

**Location:** Multiple locations - error propagation issue  
**Primary Source:** `frontend/src/components/RunTrendsCompare.tsx`  
**Lines:** 103-106, 287-298  

**Problem:**  
The error handling in `fetchRunData()` catches errors but doesn't provide specific context. The "Not found" error likely originates from:

1. **Backend route** (`backend/src/routes/chat.routes.ts` line 528): Calls `agentClient.analyzeFitnessTrend(count)` which may fail
2. **Frontend error display** (line 296): Shows generic error message without details

```typescript
// Line 103-106
} catch (err) {
    const errorMessage = err instanceof Error ? err.message : 'Failed to fetch run data';
    setError(errorMessage);  // ← Generic error
```

**Root Cause:**  
When the backend's `fetch-runs` endpoint is called with a count that doesn't match available data, or when the fitness trend analyzer fails, the error message isn't descriptive enough.

**Impact:**  
- Users see cryptic "Error: Not found" without understanding what's missing
- No guidance on how to resolve the issue
- Poor user experience

---

### Issue 4: Widget Misuse - RunTrendsCompare for Single-Run Analysis

**Location:** `frontend/src/components/Charts.tsx`  
**Lines:** 15-50, 63-64  
**Problem:**  
The `detectChartType()` function incorrectly classifies single-run analysis as "multi-run-trend" and routes to `RunTrendsCompare` widget.

```typescript
// Line 19-24
const hasMultipleMetrics = charts.length >= 4;  // ← WRONG LOGIC
const hasTimeSeriesLabels = charts[0]?.xLabels?.some(label =>
    /^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\s+\d{1,2}$/i.test(label) ||
    /run\s*\d+|last\s*\d+|recent/i.test(label)  // ← Matches "Run 1, Run 2"
);
```

**Root Cause:**  
The detection logic has two flaws:
1. **Count-based detection:** Assumes 4+ charts = multi-run trend, but single-run analysis also generates 4 charts (pace, HR, cadence, distance)
2. **Label pattern matching:** The regex matches "Run 1, Run 2" labels, which are incorrectly generated by Issue #1

**Correct behavior should be:**
- Single-run analysis: HR zones, splits, pace over time/distance → Use `SingleRunCharts`
- Multi-run trends: Metrics over multiple runs with dates → Use `RunTrendsCompare`

**Impact:**  
- Single-run analysis incorrectly shows comparison widget with range selectors
- Users can't see detailed single-run metrics (HR zones, splits)
- Performance overhead from unnecessary comparison features
- Confusing UX with inappropriate controls

---

### Issue 5: Performance Bottlenecks

**Location:** `frontend/src/components/RunTrendsCompare.tsx`  
**Lines:** 73-112, 135-163  
**Problem:**  
Multiple performance issues in the component:

1. **Debounced fetching** (lines 73-112): 300ms debounce + async fetch on every range change
2. **Unnecessary re-renders**: Component doesn't properly memoize expensive calculations
3. **Cache checking logic** (lines 82-92): Checks data length on every render
4. **Multiple useEffect hooks**: Lines 50-52, 66-70, 122-128 trigger re-renders

```typescript
// Line 80-86
fetchTimeoutRef.current = window.setTimeout(async () => {
    const currentDataLength = charts[0]?.xLabels?.length || 0;
    if (count <= currentDataLength) {  // ← Checked on every call
        setLoadingRange(null);
        return;
    }
```

**Root Cause:**  
The component was designed for dynamic data fetching in multi-run trend analysis, but this adds unnecessary complexity when used for single-run analysis (which doesn't need dynamic fetching).

**Impact:**  
- Slow rendering when switching between ranges
- Unnecessary API calls
- Poor user experience with loading states
- Wasted resources on single-run analysis

---

## COMPONENT INTERACTION FLOW

```
User: "Analyze my last run"
    ↓
Backend: chat.routes.ts (line 320)
    ↓
Agent: current_run_analyzer.py (line 98)
    ↓
Chart Builder: chart_builder.py (line 19)
    → Generates 4 charts with "Run 1, Run 2" labels ❌
    ↓
Frontend: Chat.tsx (line 386)
    ↓
Charts.tsx detectChartType() (line 15)
    → Detects as "multi-run-trend" ❌
    ↓
RunTrendsCompare.tsx (line 33)
    → Shows comparison widget with wrong controls ❌
```

**What SHOULD happen:**
```
User: "Analyze my last run"
    ↓
Backend: Routes to current_run_analyzer
    ↓
Agent: Generates single-run detailed charts
    → HR zones, splits, pace over time
    ↓
Frontend: Detects as "single-run"
    ↓
SingleRunCharts.tsx
    → Shows detailed single-run analysis ✓
```

---

## DEPENDENCIES BETWEEN ISSUES

```
Issue #1 (Wrong Labels)
    ↓ causes
Issue #4 (Widget Misuse)
    ↓ causes
Issue #2 (Wrong Range Options)
    ↓ causes
Issue #3 (Error Messages)
    ↓ causes
Issue #5 (Performance Problems)
```

**Fix Order:** Must fix in sequence 1 → 4 → 2 → 3 → 5

---

## AFFECTED FILES SUMMARY

### Backend/Agent (Python)
1. `agent-service/src/utils/chart_builder.py` - Wrong label generation
2. `agent-service/src/agents/current_run_analyzer.py` - Calling wrong chart builder

### Frontend (TypeScript/React)
1. `frontend/src/components/Charts.tsx` - Wrong detection logic
2. `frontend/src/components/RunTrendsCompare.tsx` - Wrong range options, performance issues
3. `frontend/src/types/chart.types.ts` - Wrong type definition
4. `frontend/src/components/SingleRunCharts.tsx` - Not being used for single runs

### Backend (TypeScript)
1. `backend/src/routes/chat.routes.ts` - Error handling could be improved

---

## RECOMMENDED FIX STRATEGY

### Phase 1: Backend Chart Generation (HIGH PRIORITY)
1. Create separate chart builder for single-run analysis
2. Update `current_run_analyzer.py` to use correct builder
3. Ensure proper date formatting in multi-run charts

### Phase 2: Frontend Detection (HIGH PRIORITY)
1. Fix `detectChartType()` logic in `Charts.tsx`
2. Add proper chart type indicators from backend
3. Ensure single-run analysis routes to `SingleRunCharts`

### Phase 3: Component Fixes (MEDIUM PRIORITY)
1. Update `RangeOption` type to `4 | 10`
2. Change default range to 4
3. Update UI to show only [4, 10] options

### Phase 4: Error Handling (MEDIUM PRIORITY)
1. Add descriptive error messages in backend
2. Improve error display in frontend
3. Add fallback states for missing data

### Phase 5: Performance Optimization (LOW PRIORITY)
1. Remove unnecessary debouncing for single-run
2. Optimize memoization in RunTrendsCompare
3. Add proper loading states

---

## TESTING CHECKLIST

After fixes are implemented, verify:

- [ ] Single-run analysis shows detailed charts (HR zones, splits)
- [ ] Multi-run trends show comparison widget with dates
- [ ] Range options are [4, 10] only
- [ ] Default range is 4
- [ ] No "Run 1, Run 2" labels in multi-run trends
- [ ] Error messages are descriptive
- [ ] No performance lag when switching views
- [ ] Cache works correctly for multi-run data
- [ ] Single-run doesn't trigger unnecessary fetches

---

**End of Analysis**